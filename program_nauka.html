<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiszki Renesansowe - Tryb Nauki</title>
    <link rel="stylesheet" href="style_learning.css">
</head>
<body>

    <h1>Agatkowe Fiszki - Tryb Nauki</h1>
    <div class="hint">Kliknij kartÄ™ by obrÃ³ciÄ‡ â€¢ UÅ¼yj przyciskÃ³w do nawigacji</div>

    <a href="index.html" class="nav-mode-switch">Widok Galerii (Wszystkie) ğŸ–¼ï¸</a>
    
    <div id="single-card-container">
        <!-- Tu JavaScript wstawi aktywnÄ… kartÄ™ -->
    </div>

    <div class="counter" id="counter-display">1 / ?</div>

    <div class="controls secondary-controls">
         <button id="random-btn">Losowe: OFF</button>
         <button id="fav-filter-btn">ğŸ˜ˆ Trudne</button>
         <button id="known-filter-btn" class="active-mode">âœ… Ukryj znane: ON</button>
    </div>

    <div class="controls primary-controls">
        <button id="prev-btn">Poprzednia</button>
        <button id="next-btn">NastÄ™pna</button>
    </div>

    <!-- PWA Installation -->
    <div id="pwa-install-container" style="text-align:center; display:none; margin-top: 20px;">
        <button id="pwa-install-btn" style="background:#00d2ff; color:#1e1e1e;">ğŸ“² Zainstaluj aplikacjÄ™</button>
    </div>

    <script src="data.js"></script>
    <script>
        // BAZA DANYCH
        const originalArtworkData = artworkData; // from data.js


        // Zmienne stanu
        let currentData = [...originalArtworkData]; // Kopia do pracy
        let currentIndex = 0;
        let isRandomMode = false;
        let isFavFilterMode = false;
        let isKnownFilterMode = true; // DomyÅ›lnie ukrywamy to co umiemy

        // Åadujemy trudne i znane karty z localStorage
        let difficult = JSON.parse(localStorage.getItem('agatkoweFiszkiTrudne')) || [];
        let known = JSON.parse(localStorage.getItem('agatkoweFiszkiZnane')) || [];

        // Elementy DOM
        const cardContainer = document.getElementById('single-card-container');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const randomBtn = document.getElementById('random-btn');
        const favFilterBtn = document.getElementById('fav-filter-btn');
        const knownFilterBtn = document.getElementById('known-filter-btn');
        const counterDisplay = document.getElementById('counter-display');
        const pwaInstallContainer = document.getElementById('pwa-install-container');
        const pwaInstallBtn = document.getElementById('pwa-install-btn');

        // Funkcje
        function formatToCentury(dateStr) {
             const yearMatch = dateStr.match(/(\d{4})/);
             if (yearMatch) {
                 const year = parseInt(yearMatch[1]);
                 const century = Math.ceil(year / 100);
                 const half = (year % 100 === 0 || year % 100 > 50) ? "II" : "I";
                 const romans = ["", "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X", "XI", "XII", "XIII", "XIV", "XV", "XVI", "XVII", "XVIII", "XIX", "XX", "XXI"];
                 const cRoman = romans[century] || century;
                 return `${half} poÅ‚owa ${cRoman} wieku`;
             }
             const textMatch = dateStr.match(/^(\d)\s*poÅ‚\.?\s*([IVX]+)\s*w\.?/i);
             if (textMatch) {
                 const halfNum = textMatch[1];
                 const centuryRom = textMatch[2];
                 const halfRom = halfNum === "1" ? "I" : "II";
                 return `${halfRom} poÅ‚owa ${centuryRom} wieku`;
             }
             return dateStr;
        }

        function renderCard(index) {
            if (currentData.length === 0) {
                 if(isKnownFilterMode && known.length > 0) {
                    cardContainer.innerHTML = '<div style="color:white; text-align:center; padding-top: 100px;">Brawo! Wszystko umiesz! ğŸ‰<br>MoÅ¼esz odkryÄ‡ znane karty przyciskiem na dole.</div>';
                 } else {
                    cardContainer.innerHTML = '<div style="color:white; text-align:center; padding-top: 100px;">Brak kart do wyÅ›wietlenia. <br>Oznacz najpierw coÅ› diabeÅ‚kiem! ğŸ˜ˆ</div>';
                 }
                 counterDisplay.innerText = "0 / 0";
                 prevBtn.disabled = true;
                 nextBtn.disabled = true;
                 return;
            }

            const item = currentData[index];
            const isDifficult = difficult.includes(item.title);
            const isKnown = known.includes(item.title);

            const cardHTML = `
                <div class="card" onclick="this.classList.toggle('is-flipped')">
                    <div class="card-inner">
                        <div class="card-front">
                            <div class="card-buttons">
                                <button class="action-btn devil-btn ${isDifficult ? 'is-active' : ''}" 
                                        onclick="event.stopPropagation(); toggleDifficult('${item.title}')"
                                        title="${isDifficult ? 'UsuÅ„ z trudnych' : 'Dodaj do trudnych'}">
                                    ğŸ˜ˆ
                                </button>
                                <button class="action-btn check-btn ${isKnown ? 'is-active' : ''}" 
                                        onclick="event.stopPropagation(); toggleKnown('${item.title}')"
                                        title="${isKnown ? 'Oznacz jako nieumiane' : 'Oznacz jako umiane'}">
                                    âœ…
                                </button>
                            </div>
                            <img src="${item.img}" alt="${item.title}" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div class="placeholder" style="display:none;">ZdjÄ™cie niedostÄ™pne:<br>${item.img}</div>
                        </div>
                        <div class="card-back">
                            <div class="card-buttons">
                                <button class="action-btn devil-btn ${isDifficult ? 'is-active' : ''}" 
                                        onclick="event.stopPropagation(); toggleDifficult('${item.title}')">
                                    ğŸ˜ˆ
                                </button>
                                <button class="action-btn check-btn ${isKnown ? 'is-active' : ''}" 
                                        onclick="event.stopPropagation(); toggleKnown('${item.title}')">
                                    âœ…
                                </button>
                            </div>
                            <h2>${item.title}</h2>
                            <div>
                                <span class="label">Autor:</span>
                                <p>${item.author}</p>
                            </div>
                            <div>
                                <span class="label">Data:</span>
                                <p>${formatToCentury(item.date)}</p>
                            </div>
                            <div>
                                <span class="label">Lokalizacja:</span>
                                <p>${item.location}</p>
                            </div>
                            <div>
                                <span class="label">SzkoÅ‚a/Technika:</span>
                                <p>${item.school}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Animacja wejÅ›cia (opcjonalnie)
            cardContainer.style.opacity = '0';
            setTimeout(() => {
                cardContainer.innerHTML = cardHTML;
                cardContainer.style.opacity = '1';
                updateCounter();
            }, 100);
            cardContainer.style.transition = 'opacity 0.1s ease';
        }

        function toggleDifficult(title) {
            if (difficult.includes(title)) {
                difficult = difficult.filter(t => t !== title);
            } else {
                difficult.push(title);
            }
            localStorage.setItem('agatkoweFiszkiTrudne', JSON.stringify(difficult));
            
            if (isFavFilterMode) {
                applyFilters();
            } else {
                renderCard(currentIndex);
            }
        }

        function toggleKnown(title) {
            if (known.includes(title)) {
                known = known.filter(t => t !== title);
            } else {
                known.push(title);
            }
            localStorage.setItem('agatkoweFiszkiZnane', JSON.stringify(known));

            // JeÅ›li ukrywamy znane, to ta karta powinna zniknÄ…Ä‡
            if (isKnownFilterMode) {
                applyFilters();
            } else {
                renderCard(currentIndex);
            }
        }

        function updateCounter() {
            if (currentData.length === 0) return;
            counterDisplay.innerText = `${currentIndex + 1} / ${currentData.length}`;
            
            // ObsÅ‚uga stanu przyciskÃ³w
            prevBtn.disabled = (!isRandomMode && currentIndex === 0); 
            prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
            
            nextBtn.disabled = (!isRandomMode && currentIndex === currentData.length - 1);
            nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
        }

        function nextCard() {
            if (currentIndex < currentData.length - 1) {
                currentIndex++;
                renderCard(currentIndex);
            } else if (isRandomMode && currentData.length > 0) {
                 reshuffle();
            }
        }

        function prevCard() {
            if (currentIndex > 0) {
                currentIndex--;
                renderCard(currentIndex);
            }
        }

        function toggleRandomMode() {
            isRandomMode = !isRandomMode;
            if (isRandomMode) {
                randomBtn.innerText = "Losowe: ON";
                randomBtn.classList.add('active-mode');
            } else {
                randomBtn.innerText = "Losowe: OFF";
                randomBtn.classList.remove('active-mode');
            }
            applyFilters();
        }

        function toggleFavFilter() {
            isFavFilterMode = !isFavFilterMode;
            if (isFavFilterMode) {
                favFilterBtn.classList.add('active-mode');
                favFilterBtn.innerText = "ğŸ˜ˆ Trudne: ON";
            } else {
                favFilterBtn.classList.remove('active-mode');
                favFilterBtn.innerText = "ğŸ˜ˆ Trudne";
            }
            applyFilters();
        }

        function toggleKnownFilter() {
            isKnownFilterMode = !isKnownFilterMode;
            if (isKnownFilterMode) {
                knownFilterBtn.classList.add('active-mode');
                knownFilterBtn.innerText = "âœ… Ukryj znane: ON";
            } else {
                knownFilterBtn.classList.remove('active-mode');
                knownFilterBtn.innerText = "âœ… Ukryj znane: OFF";
            }
            applyFilters();
        }

        function applyFilters() {
            // 1. Zaczynamy od bazy
            let newData = [...originalArtworkData];

            // 2. Filtrujemy trudne (jeÅ›li wÅ‚Ä…czone)
            if (isFavFilterMode) {
                newData = newData.filter(item => difficult.includes(item.title));
            }

            // 3. Filtrujemy znane (jeÅ›li wÅ‚Ä…czone)
            if (isKnownFilterMode) {
                newData = newData.filter(item => !known.includes(item.title));
            }

            // 4. ObsÅ‚uga losowoÅ›ci
            if (isRandomMode) {
                newData = shuffleArray(newData);
            }

            currentData = newData;
            currentIndex = 0;
            renderCard(currentIndex);
        }

        function reshuffle() {
            currentData = shuffleArray(currentData);
            currentIndex = 0;
            renderCard(currentIndex);
        }

        function shuffleArray(array) {
            let arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // Event Listeners - Klawiatura
        document.addEventListener('keydown', (e) => {
            if (currentData.length === 0) return;
            // Lewo / Prawo - zmiana karty
            if (e.key === 'ArrowRight' || e.key === ' ') {
                if(!isRandomMode && currentIndex === currentData.length - 1) return; 
                nextCard();
            } else if (e.key === 'ArrowLeft') {
                prevCard();
            }
            // GÃ³ra / DÃ³Å‚ - obrÃ³t karty
            if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                e.preventDefault();
                const card = document.querySelector('.card');
                if(card) card.classList.toggle('is-flipped');
            }
        });

        // Event Listeners - Przyciski
        nextBtn.addEventListener('click', nextCard);
        prevBtn.addEventListener('click', prevCard);
        randomBtn.addEventListener('click', toggleRandomMode);
        favFilterBtn.addEventListener('click', toggleFavFilter);
        knownFilterBtn.addEventListener('click', toggleKnownFilter);

        // --- OBSÅUGA PWA (Service Worker & Install) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW registered!', reg))
                    .catch(err => console.log('SW boot failed', err));
            });
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            pwaInstallContainer.style.display = 'block';
        });

        pwaInstallBtn.addEventListener('click', () => {
            if(deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the A2HS prompt');
                    }
                    deferredPrompt = null;
                     pwaInstallContainer.style.display = 'none';
                });
            }
        });


        // --- OBSÅUGA GESTÃ“W (SWIPE) NA TELEFONIE ---
        let touchStartX = 0;
        let touchStartY = 0;
        let isDragging = false;
        let currentCardElement = null;

        cardContainer.addEventListener('touchstart', (e) => {
            currentCardElement = e.target.closest('.card');
            if (!currentCardElement) return;
            // Ignoruj jeÅ›li dotkniÄ™to przycisku (np. diabeÅ‚ka)
            if (e.target.closest('button')) return;

            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            isDragging = true;
            currentCardElement.style.transition = 'none'; // Brak opÃ³Åºnienia przy przeciÄ…ganiu
        }, { passive: true });

        cardContainer.addEventListener('touchmove', (e) => {
            if (!isDragging || !currentCardElement) return;

            const touch = e.touches[0];
            const currentX = touch.clientX;
            const currentY = touch.clientY;
            const deltaX = currentX - touchStartX;
            const deltaY = currentY - touchStartY;

            // JeÅ›li przewaÅ¼a ruch pionowy, pozwalamy na scroll strony
            if (Math.abs(deltaY) > Math.abs(deltaX) + 10) return;

            const rotation = deltaX * 0.05;
            currentCardElement.style.transform = `translateX(${deltaX}px) rotate(${rotation}deg)`;
        }, { passive: true });

        cardContainer.addEventListener('touchend', (e) => {
            if (!isDragging || !currentCardElement) return;
            isDragging = false;

            const touch = e.changedTouches[0];
            const endX = touch.clientX;
            const deltaX = endX - touchStartX;
            const threshold = 80; // PrÃ³g przesuniÄ™cia

            if (deltaX < -threshold) {
                finishSwipe('left');
            } else if (deltaX > threshold) {
                finishSwipe('right');
            } else {
                // PowrÃ³t
                currentCardElement.style.transition = 'transform 0.3s ease-out';
                currentCardElement.style.transform = 'translateX(0) rotate(0)';
            }
            currentCardElement = null;
        });

        function finishSwipe(direction) {
            if (!currentCardElement) return;
            
            const screenW = window.innerWidth;
            // Wyrzucamy daleko poza ekran
            const endX = direction === 'left' ? -screenW : screenW;
            const rotation = direction === 'left' ? -30 : 30;

            currentCardElement.style.transition = 'transform 0.3s ease-in, opacity 0.3s linear';
            currentCardElement.style.transform = `translateX(${endX}px) rotate(${rotation}deg)`;
            currentCardElement.style.opacity = '0';

            setTimeout(() => {
                if (direction === 'left') {
                    // Swipe w lewo = NASTÄ˜PNA
                    if (currentIndex < currentData.length - 1 || isRandomMode) {
                        nextCard();
                    } else {
                        // Koniec listy - przywrÃ³Ä‡ kartÄ™
                        renderCard(currentIndex);
                    }
                } else {
                    // Swipe w prawo = POPRZEDNIA
                    if (currentIndex > 0) {
                        prevCard();
                    } else {
                         // PoczÄ…tek listy - przywrÃ³Ä‡ kartÄ™
                        renderCard(currentIndex);
                    }
                }
            }, 300);
        }

        // Start
        renderCard(currentIndex);

    </script>
</body>
</html>